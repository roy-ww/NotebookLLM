# 微信登录问题排查指南

## "scope参数错误或没有scope权限" 问题排查

### 问题原因

出现此错误通常有以下几种原因：

#### 1. AppID类型不匹配（最常见）

**扫码登录（qrconnect）** 必须使用**微信开放平台的网站应用**AppID：
- ✅ 网站应用：支持 `snsapi_login` scope，可以扫码登录
- ❌ 公众号AppID：不支持 `snsapi_login`，只能使用 `snsapi_base` 或 `snsapi_userinfo`

**解决方案：**
1. 登录 [微信开放平台](https://open.weixin.qq.com/)
2. 创建"网站应用"（如果没有）
3. 填写应用信息并提交审核
4. 审核通过后，获取网站应用的 AppID 和 AppSecret
5. 在 `application.yml` 中更新 AppID 和 AppSecret

#### 2. 授权回调域名未配置

在微信开放平台的网站应用设置中，必须配置授权回调域名。

**配置步骤：**
1. 登录微信开放平台
2. 进入"管理中心" > "网站应用" > 你的应用
3. 点击"开发信息"
4. 在"授权回调域名"中添加你的域名：
   - 本地测试：`localhost`
   - 生产环境：你的域名（如 `example.com`），**不要包含协议和端口号**

**重要：**
- 只填写域名，不需要 `http://` 或 `https://`
- 不需要填写端口号
- 不能填写IP地址
- 需要在域名根目录放置验证文件

#### 3. redirect_uri 格式不正确

`redirect_uri` 必须：
- 属于已配置的授权回调域名
- 进行URL编码（代码已自动处理）
- 格式正确，包含协议和路径

**示例：**
```
✅ 正确：http://localhost:3000/
✅ 正确：https://example.com/callback
❌ 错误：localhost:3000/  (缺少协议)
❌ 错误：http://192.168.1.1:3000/  (不能使用IP)
```

#### 4. 应用审核未通过

网站应用必须审核通过才能使用。

**检查方法：**
1. 登录微信开放平台
2. 查看应用状态
3. 如果显示"审核中"或"审核失败"，需要重新提交审核

### 验证步骤

#### 步骤1：确认AppID类型

在微信开放平台查看：
- 应用类型是否为"网站应用"
- 应用状态是否为"已通过"

#### 步骤2：检查授权回调域名

1. 进入网站应用 > 开发信息
2. 查看"授权回调域名"是否已配置
3. 确认配置的域名与代码中的 `redirectUri` 匹配

#### 步骤3：测试URL编码

确保 `redirect_uri` 参数已正确编码（代码已自动处理）

#### 步骤4：查看日志

启动后端应用，查看日志输出：
```bash
cd backend
mvn spring-boot:run
```

查看生成的授权URL，确认参数格式正确。

### 常见错误码

- `10003`: redirect_uri参数错误
- `10004`: scope参数错误或没有scope权限
- `10005`: 缺少access_token参数

### 联系支持

如果以上步骤都检查无误，仍出现错误，可能需要：
1. 检查微信开放平台是否有相关公告
2. 查看微信开放平台的技术支持文档
3. 确认AppID和AppSecret是否正确

