# 微信登录注册系统 - 测试用例设计

## 1. 测试策略概述

### 1.1 测试目标
确保微信登录注册系统功能正确、安全可靠、性能达标，满足用户需求和业务要求。

### 1.2 测试范围
- 微信授权登录功能
- 用户信息存储功能
- 用户账户管理功能
- 微信授权验证功能
- 数据库操作功能
- API接口功能
- 安全性测试

### 1.3 测试类型
- 单元测试：测试各个组件和方法
- 集成测试：测试服务间协作
- API测试：测试接口功能和性能
- 安全测试：测试系统安全性
- 数据库测试：测试数据操作准确性

## 2. 单元测试用例

### 2.1 WeChatService单元测试

#### 测试用例: 测试微信授权码验证功能
- **测试方法**: `validateAuthCode(String authCode)`
- **测试数据**: 
  - 有效授权码
  - 无效授权码
  - 空授权码
  - 过期授权码
- **预期结果**: 
  - 有效授权码返回成功状态
  - 无效授权码返回失败状态和错误信息

#### 测试用例: 测试获取微信用户信息功能
- **测试方法**: `getWeChatUserInfo(String accessToken, String openId)`
- **测试数据**:
  - 有效的access token和openId
  - 无效的access token
  - 不存在的openId
- **预期结果**:
  - 有效参数返回用户信息对象
  - 无效参数返回相应的错误信息

### 2.2 UserService单元测试

#### 测试用例: 测试用户创建功能
- **测试方法**: `createUser(UserInfo userInfo)`
- **测试数据**:
  - 完整的用户信息（用户名、密码、昵称、微信OpenId）
  - 缺少必要字段的用户信息
  - 重复的微信OpenId
  - 重复的用户名
- **预期结果**:
  - 完整信息创建用户成功
  - 缺少字段返回验证错误
  - 重复信息返回唯一性约束错误

#### 测试用例: 测试用户查询功能
- **测试方法**: `getUserById(Long userId)`
- **测试数据**:
  - 存在的用户ID
  - 不存在的用户ID
  - 无效的用户ID格式
- **预期结果**:
  - 存在的ID返回用户对象
  - 不存在的ID返回null或抛出异常

#### 测试用例: 测试用户信息更新功能
- **测试方法**: `updateUserInfo(Long userId, UpdateUserInfoRequest request)`
- **测试数据**:
  - 有效的用户ID和更新信息
  - 不存在的用户ID
  - 非法的昵称格式
- **预期结果**:
  - 有效数据更新成功
  - 无效ID返回错误信息

### 2.3 AuthService单元测试

#### 测试用例: 测试微信登录处理功能
- **测试方法**: `processWeChatLogin(String authCode)`
- **测试数据**:
  - 有效的微信授权码
  - 无效的微信授权码
  - 已存在的微信用户
  - 新微信用户
- **预期结果**:
  - 有效码返回登录成功和用户信息
  - 无效码返回错误信息
  - 已存在用户直接登录
  - 新用户创建后登录

## 3. 集成测试用例

### 3.1 微信登录流程集成测试

#### 测试用例: 完整微信登录流程
- **测试场景**: 模拟用户从点击登录到成功登录的完整流程
- **测试步骤**:
  1. 调用获取微信授权URL接口
  2. 使用模拟的授权码调用微信登录接口
  3. 验证用户是否被正确创建或登录
  4. 验证返回的认证信息是否正确
- **测试数据**: 模拟的微信授权响应
- **预期结果**: 
  - 新用户被创建并成功登录
  - 老用户被直接登录
  - 返回有效的认证令牌

#### 测试用例: 微信登录错误处理流程
- **测试场景**: 测试各种错误情况下的处理
- **测试步骤**:
  1. 使用无效授权码调用登录接口
  2. 验证系统的错误处理
  3. 检查错误日志和响应
- **测试数据**: 无效的微信授权码
- **预期结果**: 返回适当的错误信息，系统不崩溃

### 3.2 用户信息管理集成测试

#### 测试用例: 用户信息查询和更新流程
- **测试场景**: 完整的用户信息查看和更新流程
- **测试步骤**:
  1. 通过认证的用户调用获取个人信息接口
  2. 验证返回的用户信息正确性
  3. 调用更新用户信息接口
  4. 验证数据库中信息被正确更新
- **测试数据**: 有效的认证令牌和更新请求
- **预期结果**: 用户信息能够正确查询和更新

## 4. API接口测试用例

### 4.1 微信认证相关API测试

#### 测试用例: POST /api/auth/wechat/login
- **测试目的**: 验证微信登录接口功能
- **请求参数**:
  - Headers: Content-Type: application/json
  - Body: {"code": "微信授权码"}
- **测试场景**:
  1. 使用有效的微信授权码
  2. 使用无效的微信授权码
  3. 不提供code参数
  4. code参数为空
- **预期结果**:
  - 有效码: HTTP 200, 返回认证令牌和用户信息
  - 无效码: HTTP 400或401, 返回错误信息
  - 缺少参数: HTTP 400, 返回参数错误信息

#### 测试用例: GET /api/auth/wechat/callback
- **测试目的**: 验证微信授权回调接口
- **请求参数**:
  - Query: code=授权码, state=状态参数
- **测试场景**:
  1. 使用有效的授权码和状态参数
  2. 使用无效的授权码
  3. 缺少code参数
  4. 缺少state参数
- **预期结果**:
  - 有效参数: HTTP 302重定向或返回认证信息
  - 无效参数: HTTP 400, 返回错误信息

### 4.2 用户管理API测试

#### 测试用例: GET /api/user/profile
- **测试目的**: 验证获取用户信息接口
- **请求参数**:
  - Headers: Authorization: Bearer {token}
- **测试场景**:
  1. 使用有效的认证令牌
  2. 使用无效的认证令牌
  3. 不提供认证令牌
  4. 认证令牌过期
- **预期结果**:
  - 有效令牌: HTTP 200, 返回用户信息
  - 无效令牌: HTTP 401, 返回认证错误

#### 测试用例: PUT /api/user/profile
- **测试目的**: 验证更新用户信息接口
- **请求参数**:
  - Headers: Authorization: Bearer {token}
  - Body: JSON格式的更新数据
- **测试场景**:
  1. 使用有效的认证令牌和有效数据
  2. 使用有效的认证令牌和无效数据
  3. 使用无效的认证令牌
- **预期结果**:
  - 有效请求: HTTP 200, 返回成功信息
  - 无效数据: HTTP 400, 返回验证错误

## 5. 数据库测试用例

### 5.1 用户数据存储测试

#### 测试用例: 用户数据插入测试
- **测试目的**: 验证用户数据能够正确插入数据库
- **测试步骤**:
  1. 准备用户数据对象
  2. 调用用户创建方法
  3. 直接查询数据库验证数据
  4. 验证字段值和默认值
- **测试数据**: 用户名、密码、昵称、微信OpenId
- **预期结果**: 数据正确插入数据库，所有字段值正确，创建时间自动设置

#### 测试用例: 用户数据唯一性约束测试
- **测试目的**: 验证用户名和微信OpenId的唯一性约束
- **测试步骤**:
  1. 插入第一个用户记录
  2. 尝试插入相同用户名的用户
  3. 尝试插入相同微信OpenId的用户
  4. 验证约束是否生效
- **预期结果**: 重复的用户名或微信OpenId应导致插入失败

#### 测试用例: 用户数据查询测试
- **测试目的**: 验证用户数据的查询功能
- **测试步骤**:
  1. 在数据库中插入测试用户数据
  2. 使用不同的查询条件查询用户
  3. 验证查询结果的正确性
- **查询条件**: 按ID查询、按用户名查询、按微信OpenId查询
- **预期结果**: 查询返回正确的用户数据

#### 测试用例: 用户数据更新测试
- **测试目的**: 验证用户数据的更新功能
- **测试步骤**:
  1. 在数据库中插入初始用户数据
  2. 调用用户更新方法
  3. 查询数据库验证更新结果
  4. 验证更新时间自动更新
- **预期结果**: 用户数据被正确更新，更新时间字段自动更新为当前时间

## 6. 安全性测试用例

### 6.1 认证安全测试

#### 测试用例: 未授权访问测试
- **测试目的**: 验证受保护接口的访问控制
- **测试步骤**:
  1. 尝试在未认证状态下访问受保护API
  2. 验证系统是否拒绝访问
- **预期结果**: 返回HTTP 401未授权错误

#### 测试用例: 无效令牌测试
- **测试目的**: 验证使用无效令牌的访问控制
- **测试步骤**:
  1. 使用伪造的或损坏的令牌访问受保护API
  2. 验证系统是否拒绝访问
- **预期结果**: 返回HTTP 401未授权错误

### 6.2 数据安全测试

#### 测试用例: 密码加密存储测试
- **测试目的**: 验证用户密码是否被安全加密存储
- **测试步骤**:
  1. 创建一个新用户，使用已知密码
  2. 直接查询数据库中的密码字段
  3. 验证密码是否与原始密码不同
- **预期结果**: 数据库中的密码是加密后的字符串，不是明文

#### 测试用例: 敏感信息保护测试
- **测试目的**: 验证敏感信息在API响应中的保护
- **测试步骤**:
  1. 获取用户信息API的响应
  2. 检查响应中是否包含密码等敏感信息
- **预期结果**: API响应中不包含密码等敏感信息

## 7. 性能测试用例

### 7.1 API响应时间测试

#### 测试用例: 微信登录API响应时间
- **测试目的**: 验证微信登录API的响应时间
- **测试方法**:
  - 使用性能测试工具模拟多用户并发登录
  - 测量API响应时间
- **预期结果**: 
  - 单用户请求响应时间 < 2秒
  - 10个并发用户平均响应时间 < 3秒

### 7.2 数据库操作性能测试

#### 测试用例: 用户查询性能测试
- **测试目的**: 验证用户查询操作的性能
- **测试方法**:
  - 在数据库中创建大量用户数据（如10000条）
  - 执行用户查询操作
  - 测量查询执行时间
- **预期结果**: 查询响应时间 < 500ms

## 8. 异常处理测试用例

### 8.1 微信API异常测试

#### 测试用例: 微信API不可用测试
- **测试目的**: 验证当微信API不可用时的系统行为
- **测试步骤**:
  1. 模拟微信API调用失败的情况
  2. 触发需要调用微信API的操作
  3. 验证系统的错误处理
- **预期结果**: 系统返回适当的错误信息，不崩溃

### 8.2 数据库连接异常测试

#### 测试用例: 数据库连接失败测试
- **测试目的**: 验证数据库连接失败时的系统行为
- **测试步骤**:
  1. 模拟数据库连接失败
  2. 执行需要数据库操作的API
  3. 验证系统的错误处理
- **预期结果**: 返回数据库连接错误信息，系统保持稳定

## 9. 测试执行计划

### 9.1 测试优先级
1. 高优先级: 核心功能测试、安全测试
2. 中优先级: API功能测试、数据库测试
3. 低优先级: 性能测试、边界条件测试

### 9.2 测试环境
- 单元测试: 本地开发环境
- 集成测试: 专用测试环境
- 性能测试: 性能测试环境

### 9.3 测试自动化
- 使用JUnit 5进行单元测试
- 使用Mockito进行依赖模拟
- 使用TestContainers进行集成测试
- 使用REST Assured进行API测试
- 集成到CI/CD流水线中